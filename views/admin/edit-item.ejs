<%- include('../partials/header', { title: 'تعديل المنتج', user: user }) %>

<div class="container admin-container">
    <div class="admin-header">
        <h1>تعديل المنتج</h1>
        <p>تعديل معلومات المنتج في القائمة</p>
    </div>

    <div class="admin-nav">
        <a href="/admin/items" class="admin-nav-link">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            العودة للمنتجات
        </a>
    </div>

    <div class="admin-section">
        <div class="section-header">
            <h2>معلومات المنتج</h2>
        </div>

        <div class="add-product-card">
            <form action="/item/edit/<%= item._id %>" method="POST" enctype="multipart/form-data" class="product-form" onsubmit="console.log('Form submitted')">
                <div class="form-grid">
                    <div class="form-column">
                        <div class="form-group-card">
                            <label for="item-name">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                                اسم المنتج *
                            </label>
                            <input type="text" id="item-name" name="name" value="<%= item.name %>" placeholder="مثال: برجر دبل تشيز كلاسيك" required>
                        </div>

                        <div class="form-group-card">
                            <label for="item-des">الوصف</label>
                            <textarea id="item-des" name="des" placeholder="اكتب وصفاً جذاباً للمنتج..."><%= item.des %></textarea>
                        </div>

                        <div class="form-group-card">
                            <label for="item-price">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="1" x2="12" y2="23"/>
                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                </svg>
                                السعر (د.ع) *
                            </label>
                            <input type="number" id="item-price" name="price" value="<%= item.price %>" placeholder="0.00" step="0.01" required>
                        </div>
                    </div>

                    <div class="form-column">
                        <div class="form-group-card">
                            <label for="item-category">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/>
                                </svg>
                                الفئة *
                            </label>
                            <select id="item-category" name="category" required>
                                <option value="">اختر الفئة</option>
                                <% categories.forEach(category => { %>
                                    <option value="<%= category._id %>" <%= item.category.toString() === category._id.toString() ? 'selected' : '' %>>
                                        <%= category.name %>
                                    </option>
                                <% }) %>
                            </select>
                        </div>

                        <div class="form-group-card">
                            <label for="item-image">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21 15 16 10 5 21"/>
                                </svg>
                                صورة المنتج
                            </label>
                            <div class="file-input-wrapper">
                                <input type="file" id="item-image" name="image" accept="image/*" onchange="previewImage(this)">
                                <div class="file-input-label">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="17 8 12 3 7 8"/>
                                        <line x1="12" y1="3" x2="12" y2="15"/>
                                    </svg>
                                    <span>اسحب الصورة هنا أو انقر للاختيار</span>
                                </div>
                                <div class="image-preview" id="imagePreview" style="display: none;">
                                    <img id="previewImg" src="" alt="Preview">
                                    <button type="button" class="remove-image" onclick="removeImage()">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="18" y1="6" x2="6" y2="18"/>
                                            <line x1="6" y1="6" x2="18" y2="18"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <small class="form-help">الصيغ المدعومة: JPG, PNG, GIF, WEBP (حتى 5 ميجابايت)</small>

                            <% if (item.image && item.image !== 'noImage.png') { %>
                                <div class="current-image" style="margin-top: 15px;">
                                    <p style="margin-bottom: 10px; color: #84ff58;">الصورة الحالية:</p>
                                    <div class="current-image-preview" style="max-width: 200px; border-radius: 8px; overflow: hidden;">
                                        <img src="<%= item.image %>" alt="<%= item.name %>" style="width: 100%; height: auto;">
                                    </div>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-large">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        حفظ التغييرات
                    </button>
                    <a href="/admin/items" class="btn btn-secondary btn-large">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                        إلغاء
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        const preview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const removeBtn = preview.querySelector('.remove-image');
        const label = input.closest('.file-input-wrapper').querySelector('.file-input-label');

        reader.onload = function(e) {
            previewImg.src = e.target.result;
            preview.style.display = 'block';
            if (label) label.style.display = 'none';
            if (removeBtn) removeBtn.style.display = 'block';
        }

        reader.readAsDataURL(input.files[0]);
    }
}

function removeImage() {
    const input = document.getElementById('item-image');
    const preview = document.getElementById('imagePreview');
    const removeBtn = preview.querySelector('.remove-image');
    const label = input.closest('.file-input-wrapper').querySelector('.file-input-label');

    input.value = '';
    const img = preview.querySelector('img');
    if (img) img.remove();
    preview.style.display = 'none';
    if (label) label.style.display = 'flex';
    if (removeBtn) removeBtn.style.display = 'none';
}
</script>

<%- include('../partials/footer') %>
